

### API 设计规范

###### 内部微服务调用协议.

内部服务之间的请求调用统一使用 gRPC， 使用 pb 序列化。
项目中将部分应用采用 gRPC. 由于历史原因不能全部推广替换.用protobuf生成文档.


## API 版本兼容性要求

API接口文档中以V1 V2 来定义接口版本.如 v1/article/airewrite

#### 服务命名规范

不要用简写,要能完成表达含义.同时保持简介.定义一套简写统称.

- 要与业务意义相符，能如,文章用article,楼盘用loupan
    

**包名**为应用的标识(APP_ID)，用于生成 gRPC 请求路径，文件中声明的包名称应该与产品和服务名称保持一致。带有版本的 API 的软件包名称必须以此版本结尾。

- 例如 ：`my.package.v1`, `google.calendar.v3` 。

- RequestURL:` /<package_name>.<version>.<service_name>/{method}`



### 向后不兼容(破坏性)的修改

- 删除或重命名服务，字段，方法或枚举值。必须增加版本号。 

- 修改字段的类型，即使新类型是传输格式兼容的，这也可能会导致客户端库生成的代码发生变化，因此必须增加版本号。 

- 修改现有请求的可见行为，客户端通常依赖于 *API* 行为和语义，即使这样的行为没有被明确支持或记录。 因此，在大多数情况下，修改 *API* 数据的行为或语义将被消费者视为是破坏性的。


## API 错误

一些建议

- 推荐用标准的 http 2.0 的状态码。
- 不要透传错误码，吞掉下游的错误码。



### 错误码


参考 [`google.rpc.Code`](https://github.com/googleapis/googleapis/blob/master/google/rpc/code.proto)中定义的所有gRPC错误代码及其原因的简短说明。 

| HTTP | RPC                     | 描述                                                         |
| :--- | :---------------------- | :----------------------------------------------------------- |
| 200  | **OK**                  | 没有错误                                                     |
| 400  | **INVALID_ARGUMENT**    | 客户端指定了无效的参数。 检查错误消息和错误详细信息以获取更多信息。 |
| 400  | **FAILED_PRECONDITION** | 请求不能在当前系统状态下执行，例如删除非空目录。             |
| 400  | **OUT_OF_RANGE**        | 客户端指定了无效的范围。                                     |
| 401  | **UNAUTHENTICATED**     | 由于遗失，无效或过期的OAuth令牌而导致请求未通过身份验证。    |
| 403  | **PERMISSION_DENIED**   | 客户端没有足够的权限。这可能是因为OAuth令牌没有正确的范围，客户端没有权限，或者客户端项目尚未启用API。 |
| 404  | **NOT_FOUND**           | 找不到指定的资源，或者该请求被未公开的原因（例如白名单）拒绝。 |
| 409  | **ABORTED**             | 并发冲突，例如读-修改-写冲突。                               |
| 409  | **ALREADY_EXISTS**      | 客户端尝试创建的资源已存在。                                 |
| 429  | **RESOURCE_EXHAUSTED**  | 资源配额达到速率限制。 客户端应该查找google.rpc.QuotaFailure错误详细信息以获取更多信息。 |
| 499  | **CANCELLED**           | 客户端取消请求                                               |
| 500  | **DATA_LOSS**           | 不可恢复的数据丢失或数据损坏。 客户端应该向用户报告错误。    |
| 500  | **UNKNOWN**             | 未知的服务器错误。 通常是服务器错误。                        |
| 500  | **INTERNAL**            | 内部服务错误。 通常是服务器错误。                            |
| 501  | **NOT_IMPLEMENTED**     | 服务器未实现该API方法。                                      |
| 503  | **UNAVAILABLE**         | 暂停服务。通常是服务器已经关闭。                             |
| 504  | **DEADLINE_EXCEEDED**   | 已超过请求期限。如果重复发生，请考虑降低请求的复杂性。       |



### 错误处理

**错误传播**

如果 *API* 服务依赖于其他服务，则不应将这些服务的错误传播到客户端


